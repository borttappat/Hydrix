# Pentest VM - Truly minimal base image
# ~2GB image that only includes:
# - Boot essentials
# - Network tools
# - Git for cloning Hydrix
# - Shaping services for first-boot setup
{ config, pkgs, lib, ... }:

{
  # Allow unfree firmware for hardware support
  nixpkgs.config.allowUnfree = true;

  imports = [
    ../modules/base/nixos-base-minimal.nix
    ../modules/base/users.nix
    ../modules/base/networking.nix
    ../modules/vm/qemu-guest.nix
    ../modules/vm/hydrix-clone.nix
    ../modules/vm/hardware-setup.nix
    ../modules/vm/shaping.nix
  ];

  # Hostname - will be used by shaping service to detect VM type
  networking.hostName = lib.mkForce "pentest-vm";

  # Absolutely minimal packages for bootstrapping only
  environment.systemPackages = with pkgs; [
    git              # Clone Hydrix repo
    vim              # Basic editing if needed
    curl             # Network testing
    nixos-rebuild    # For shaping
  ];

  # Disable unnecessary services
  services = {
    xserver.enable = lib.mkForce false;  # No X11 in base
  };

  # Boot and filesystem config handled by nixos-generators format
}
