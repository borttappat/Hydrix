# Pentest VM - Full profile
# Used for both:
#   1. Building full VM images (nix build '.#pentest-vm-full')
#   2. Rebuilding inside VMs (nixos-rebuild switch --flake '.#vm-pentest')
#
{ config, pkgs, lib, modulesPath, ... }:

{
  imports = [
    # QEMU guest profile from nixpkgs
    (modulesPath + "/profiles/qemu-guest.nix")

    # Base system
    ../modules/base/nixos-base.nix
    ../modules/base/users-vm.nix  # VM-isolated user (not host secrets)
    ../modules/base/networking.nix
    ../modules/vm/qemu-guest.nix
    ../modules/vm/hydrix-clone.nix  # Clone Hydrix repo on first boot

    # Core desktop environment (i3, fish, etc.)
    ../modules/core.nix

    # Theming system
    ../modules/theming/static-colors.nix  # Static red theme for pentest
    ../modules/desktop/xinitrc.nix        # X session bootstrap + config deployment

    # Pentesting modules
    ../modules/pentesting/hosts.nix       # CTF/HTB host mappings
    ../modules/pentesting/proxychains.nix # Declarative proxy configuration
    ../modules/pentesting/pentesting.nix  # Full pentesting toolkit
    ../modules/desktop/firefox.nix        # Firefox with extensions
  ];

  # ===== Inline hardware configuration for QEMU VMs =====
  # No need for /etc/nixos/hardware-configuration.nix - QEMU hardware is always the same
  boot.initrd.availableKernelModules = [
    "virtio_balloon" "virtio_blk" "virtio_pci" "virtio_ring"
    "virtio_net" "virtio_scsi" "virtio_console"
    "ahci" "xhci_pci" "sd_mod" "sr_mod"
  ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" "kvm-amd" ];
  boot.extraModulePackages = [ ];

  # Boot loader
  boot.loader.grub = {
    enable = true;
    device = lib.mkDefault "/dev/vda";
    efiSupport = false;
    useOSProber = false;
  };

  # Filesystem - nixos-generators creates disk with label "nixos"
  fileSystems."/" = lib.mkDefault {
    device = "/dev/disk/by-label/nixos";
    fsType = "ext4";
  };

  swapDevices = [ ];

  networking.useDHCP = lib.mkDefault true;
  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";

  # Hostname - use mkForce to override networking.nix default
  networking.hostName = lib.mkForce "pentest-vm";

  # VM type and colorscheme
  hydrix.vmType = "pentest";
  hydrix.colorscheme = "perp";

  # Simple rebuild script
  environment.systemPackages = with pkgs; [
    (pkgs.writeShellScriptBin "rebuild" ''
      #!/usr/bin/env bash
      set -e
      cd ~/Hydrix
      echo "Rebuilding system..."
      sudo nixos-rebuild switch --flake '.#vm-pentest' --impure
    '')
  ];
}
