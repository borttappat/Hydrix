# Pentest VM - Full standalone image (no shaping required)
# This builds a complete, ready-to-use pentesting VM image
#
# Build: nix build '.#pentest-vm-full'
# Deploy: ./scripts/deploy-full-vm.sh pentest myname
# Updates inside VM: rebuild
#
{ config, pkgs, lib, modulesPath, ... }:

{
  imports = [
    # Import the full pentest profile (has inline hardware config)
    ./pentest-full.nix
  ];

  # Clone Hydrix repo on first boot for future updates
  systemd.services.hydrix-clone = {
    description = "Clone Hydrix repository for updates";
    wantedBy = [ "multi-user.target" ];
    after = [ "network-online.target" ];
    wants = [ "network-online.target" ];

    unitConfig = {
      ConditionPathExists = "!/home/traum/Hydrix/.git";
    };

    serviceConfig = {
      Type = "oneshot";
      RemainAfterExit = true;
      User = "traum";
      Group = "users";
      TimeoutStartSec = "300";
    };

    script = ''
      # Wait for network
      for i in {1..30}; do
        if ${pkgs.curl}/bin/curl -sf --connect-timeout 2 https://github.com >/dev/null 2>&1; then
          break
        fi
        sleep 2
      done

      # Clone if not present
      if [ ! -d /home/traum/Hydrix/.git ]; then
        ${pkgs.git}/bin/git clone https://github.com/borttappat/Hydrix.git /home/traum/Hydrix
        chmod +x /home/traum/Hydrix/scripts/*.sh 2>/dev/null || true
      fi
    '';
  };
}
