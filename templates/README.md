# Hydrix Templates

This directory contains templates used by `setup.sh` and `build-vm.sh` to generate configurations.

## VM Build Workflow (Baked + Orphaned Model)

VMs are built with all configuration **baked in** at build time. After deployment,
VMs are **orphaned** - they don't need to sync with the host.

### How build-vm.sh Works

```
┌─────────────────────────────────────────────────────────────┐
│                     BUILD TIME (Host)                       │
├─────────────────────────────────────────────────────────────┤
│  User runs: ./build-vm.sh --type pentest --name google      │
│                                                             │
│  1. Prompt for password (or use --password flag)            │
│  2. Generate local/vms/<hostname>.nix (secrets)             │
│  3. Generate local/vm-instance.nix (hostname config)        │
│  4. Build VM image (secrets + config baked in)              │
│  5. Deploy to libvirt                                       │
│  6. Clean up vm-instance.nix                                │
│  7. Save credentials reference                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    RUNTIME (VM)                             │
├─────────────────────────────────────────────────────────────┤
│  /home/<user>/Hydrix/  ← Baked in from host                 │
│                                                             │
│  VM is ORPHANED:                                            │
│    • No git pull needed                                     │
│    • rebuild script uses local baked config                 │
│    • virtiofs /nix/store = fast rebuilds                    │
└─────────────────────────────────────────────────────────────┘
```

### Generated Files

| File | Purpose | Lifetime |
|------|---------|----------|
| `local/vms/<hostname>.nix` | VM secrets (user, password hash) | Permanent |
| `local/vm-instance.nix` | Hostname config for build | Temporary |
| `local/credentials/<hostname>.json` | Credential reference | Permanent |

## Directory Structure

```
templates/
├── flake.nix.template          # Main flake (generates ~/local-hydrix/flake.nix)
├── machine.nix.template        # Host machine profile
├── secrets/
│   ├── host.nix.template       # Host secrets (username, password, SSH keys)
│   ├── router.nix.template     # Router VM secrets
│   └── vm.nix.template         # Per-VM secrets (reference format)
└── README.md                   # This file
```

## How Setup Works

When `scripts/setup.sh` runs, it creates `~/local-hydrix/` with:

1. **Symlinks** to Hydrix (for shared content):
   - `modules/` → `~/Hydrix/modules/`
   - `configs/` → `~/Hydrix/configs/`
   - `scripts/` → `~/Hydrix/scripts/`
   - `colorschemes/` → `~/Hydrix/colorschemes/`
   - `wallpapers/` → `~/Hydrix/wallpapers/`

2. **Generated files** (from templates):
   - `flake.nix` - From `flake.nix.template`
   - `machines/<hostname>.nix` - From `machine.nix.template`
   - `secrets/host.nix` - From `secrets/host.nix.template`
   - `secrets/router.nix` - From `secrets/router.nix.template`

3. **Created directories**:
   - `local/vms/` - Per-VM secrets (generated by build-vm.sh)
   - `local/credentials/` - VM credential references

## Templates

### machine.nix.template (was machine-profile-full.nix.template)
**Used by**: `scripts/setup.sh`
**Purpose**: Complete machine profile with VFIO passthrough, bridges, and specialisations

**Variables**:
- `{{MACHINE_NAME}}` - Hostname/machine identifier
- `{{DATE}}` - Generation timestamp
- `{{CPU_PLATFORM}}` - CPU vendor (intel/amd)
- `{{IS_ASUS}}` - Whether system is ASUS hardware (true/false)
- `{{PRIMARY_ID}}` - WiFi device vendor:product ID (e.g., "8086:a0f0")
- `{{PRIMARY_PCI}}` - WiFi PCI address (e.g., "0000:00:14.3")
- `{{PRIMARY_PCI_SHORT}}` - Short PCI format for virt-install (e.g., "00:14.3")
- `{{PRIMARY_DRIVER}}` - WiFi kernel driver to blacklist (e.g., "iwlwifi")
- `{{PRIMARY_INTERFACE}}` - WiFi interface name (e.g., "wlan0")
- `{{IOMMU_PARAM}}` - IOMMU kernel parameter (intel_iommu=on or amd_iommu=on)
- `{{USER}}` - Detected username
- `{{HW_IMPORTS}}` - Conditional hardware module imports (Intel, ASUS, user config)

**Generated Features**:
- VFIO passthrough configuration for WiFi NIC
- Network bridges (br-mgmt, br-pentest, br-office, br-browse, br-dev)
- Router VM autostart systemd service
- Fallback specialisation (re-enables WiFi, disables VFIO)
- Lockdown specialisation (isolates host from internet)
- Status commands (vm-status, router-status, lockdown-status, fallback-status)

### secrets/host.nix.template
**Used by**: `scripts/setup.sh`
**Purpose**: Host secrets (username, password hash, SSH keys, system settings)

**Variables**:
- `@@USERNAME@@` - Primary user account name
- `@@PASSWORD_HASH@@` - SHA-512 password hash
- `@@TIMEZONE@@` - System timezone (e.g., "Europe/Stockholm")
- `@@LOCALE@@` - System locale (e.g., "en_US.UTF-8")
- `@@KEYBOARD_LAYOUT@@` - Keyboard layout (e.g., "us")
- `@@LUKS_DEVICE@@` - LUKS encrypted device path (if applicable)
- `@@DATE@@` - Generation timestamp
- `@@HOSTNAME@@` - Machine hostname

### secrets/router.nix.template
**Used by**: `scripts/setup.sh`
**Purpose**: Router VM credentials

**Variables**:
- `@@ROUTER_USERNAME@@` - Router VM user (default: "user")
- `@@ROUTER_PASSWORD_HASH@@` - SHA-512 password hash
- `@@DATE@@` - Generation timestamp

### secrets/vm.nix.template
**Used by**: `scripts/build-vm.sh`
**Purpose**: Per-VM secrets and configuration

**Variables**:
- `@@VM_DISPLAY_NAME@@` - Display name in virt-manager
- `@@VM_HOSTNAME@@` - VM hostname (can differ for OPSEC)
- `@@VM_TYPE@@` - VM type (pentest, browsing, comms, dev)
- `@@VM_BRIDGE@@` - Network bridge (br-pentest, br-browsing, etc.)
- `@@VM_USERNAME@@` - VM user account (default: host username)
- `@@VM_PASSWORD_HASH@@` - SHA-512 password hash
- `@@DATE@@` - Generation timestamp

### flake.nix.template (TODO)
**Used by**: `scripts/setup.sh`
**Purpose**: Main flake with machine entries

This template will generate `~/local-hydrix/flake.nix` with:
- References to symlinked modules
- Machine-specific configuration entries
- VM image build targets

### Legacy Templates (to be removed)
- `flake-entry.nix.template` - Obsolete, replaced by full flake template
- `router-vm-config.nix.template` - Obsolete, router config is now in modules

## How nixbuild.sh Works

`scripts/nixbuild.sh` uses **hostname-based detection** - no templates needed:

**Physical machines:**
```bash
# Uses hostname directly as flake target
FLAKE_TARGET="$HOSTNAME"
# Builds: nixos-rebuild switch --flake .#<hostname>
```

**VMs:**
```bash
# Extracts type from hostname pattern (e.g., "pentest-google" → "pentest")
VM_TYPE="${hostname%%-*}"
FLAKE_TARGET="vm-${VM_TYPE}"
# Builds: nixos-rebuild switch --flake .#vm-pentest
```

**Specialisation handling:**
- Detects current specialisation (lockdown/router/fallback)
- Maintains same mode across rebuilds
- Mode changes require reboot via bootloader

## Critical Rule: Mode Switching

**IMPORTANT**: Machines with specialisations that change kernel parameters or blacklist modules:
- **CANNOT switch modes live** (requires reboot)
- nixbuild.sh **detects and maintains current mode**
- Mode changes happen via **bootloader menu selection**

**Why?**
- Kernel parameters (`intel_iommu=on`, `vfio-pci.ids=...`) require reboot
- Kernel module blacklists require reboot
- Attempting to switch live will appear to work but won't actually apply changes

**Correct flow**:
1. Boot into desired mode via bootloader
2. Run `scripts/nixbuild.sh` - rebuilds in current mode
3. To change modes: reboot and select different specialisation in bootloader
