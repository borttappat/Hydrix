# pentesting.nix - Full pentesting toolkit and environment setup
#
# Provides:
# - Docker for containers
# - Havoc C2 framework setup with shell.nix
# - Wordlists and tool repositories
# - Extensive pentesting tool collection
# - MySQL/MariaDB service
# - Time manipulation for Kerberos attacks
#
# Ported from ~/dotfiles/modules/pentesting.nix

{ config, pkgs, lib, ... }:

{
  # Docker for containers
  virtualisation.docker.enable = true;

  # Clone pentesting tool repositories on activation
  system.activationScripts.pentest-repos = ''
    TOOLS_DIR="/home/traum/tools"

    mkdir -p "$TOOLS_DIR"

    if [ ! -d "$TOOLS_DIR/Havoc" ]; then
        ${pkgs.git}/bin/git clone https://github.com/HavocFramework/Havoc "$TOOLS_DIR/Havoc"

        cat > "$TOOLS_DIR/Havoc/shell.nix" << 'EOF'
{ pkgs ? import <nixpkgs> {} }:

pkgs.mkShell {
  buildInputs = with pkgs; [
    gnumake
    cmake
    pkg-config
    gcc
    git
    qt5.qtbase
    qt5.qttools
    qt5.qtwebsockets
    qt5.qtdeclarative
    libsForQt5.full
    python3
    go
    openssl
    zlib
    boost
    libGL
    libGLU
    fontconfig
    freetype
    xorg.libX11
    xorg.libXext
    xorg.libXrender
    ncurses
    gdbm
    readline
    libffi
    sqlite
    bzip2
    nasm
    python3Packages.pycryptodome
    python3Packages.requests
    python3Packages.websocket-client
  ];

  shellHook = "exec fish";

}
EOF
    fi

    if [ ! -d "$TOOLS_DIR/SharpCollection" ]; then
        ${pkgs.git}/bin/git clone  https://github.com/Flangvik/SharpCollection "$TOOLS_DIR/SharpCollection"
    fi

    if [ ! -d "$TOOLS_DIR/CS-Situational-Awareness-BOF" ]; then
        ${pkgs.git}/bin/git clone https://github.com/trustedsec/CS-Situational-Awareness-BOF "$TOOLS_DIR/CS-Situational-Awareness-BOF"

        cat > "$TOOLS_DIR/CS-Situational-Awareness-BOF/shell.nix" << 'EOF'
{ pkgs ? import <nixpkgs> {} }:

pkgs.mkShell {
  buildInputs = with pkgs; [
    gnumake
    pkgsCross.mingwW64.buildPackages.gcc
    git
  ];

  shellHook = "exec fish";

}
EOF
    fi

    if [ ! -d "$TOOLS_DIR/nanodump" ]; then
        ${pkgs.git}/bin/git clone https://github.com/fortra/nanodump "$TOOLS_DIR/nanodump"

        cat > "$TOOLS_DIR/nanodump/shell.nix" << 'EOF'
{ pkgs ? import <nixpkgs> {} }:

pkgs.mkShell {
  buildInputs = with pkgs; [
    gnumake
    pkgsCross.mingwW64.buildPackages.gcc
    git
  ];

  shellHook = "exec fish";

}
EOF
    fi

    if [ ! -d "$TOOLS_DIR/donut" ]; then
        ${pkgs.git}/bin/git clone https://github.com/TheWover/donut "$TOOLS_DIR/donut"

        cat > "$TOOLS_DIR/donut/shell.nix" << 'EOF'
{ pkgs ? import <nixpkgs> {} }:

pkgs.mkShell {
  buildInputs = with pkgs; [
    gnumake
    gcc
    pkgsCross.mingwW64.buildPackages.gcc
    git
  ];

  shellHook = "exec fish";

}
EOF
    fi

    if [ ! -d "$TOOLS_DIR/DSViper" ]; then
        ${pkgs.git}/bin/git clone https://github.com/dagowda/DSViper "$TOOLS_DIR/DSViper"

        cat > "$TOOLS_DIR/DSViper/shell.nix" << 'EOF'
{ pkgs ? import <nixpkgs> {} }:

pkgs.mkShell {
  buildInputs = with pkgs; [
    python3
    python3Packages.pip
    python3Packages.virtualenv
    pkgsCross.mingwW64.buildPackages.gcc
    mono
    unzip
    wget
  ];

  shellHook = "exec fish";

}
EOF
    fi

    chown -R traum:users "$TOOLS_DIR"
  '';

  # Disable automatic time synchronization (for Kerberos attacks)
  services.timesyncd.enable = lib.mkForce false;
  services.ntp.enable = lib.mkForce false;

  # Wordlists setup
  system.activationScripts.wordlists = ''
    mkdir -p /home/traum/wordlists
    ln -sfn $(${pkgs.wordlists}/bin/wordlists_path) /home/traum/wordlists/all
    chown -R traum:users /home/traum/wordlists
  '';

  # Pentesting packages
  environment.systemPackages = with pkgs; [
    # Time manipulation script for Kerberos attacks
    (pkgs.writeShellScriptBin "pentest-time" ''
      #!/usr/bin/env bash

      set -e

      function print_usage {
        echo "Usage:"
        echo "  sudo $0 -t <target_ip>    # Set time to match target"
        echo "  sudo $0 -r                # Restore time from public NTP servers"
        echo "  sudo $0 -i                # Show current time information"
        exit 1
      }

      if [ "$EUID" -ne 0 ]; then
        echo "Please run as root (sudo)"
        exit 1
      fi

      if [ "$#" -lt 1 ]; then
        print_usage
      fi

      case "$1" in
        -t|--target)
          if [ -z "$2" ]; then
            echo "Error: Target IP address required"
            print_usage
          fi
          echo "Setting time to match target: $2"
          if ! ${pkgs.ntp}/bin/ntpdate -s "$2" 2>/dev/null; then
            echo "NTP sync failed. You may need to set time manually."
          else
            echo "Time set successfully to: $(date)"
          fi
          ;;
        -r|--restore)
          echo "Restoring time from public NTP servers..."
          if ${pkgs.ntp}/bin/ntpdate -s pool.ntp.org 2>/dev/null || ${pkgs.ntp}/bin/ntpdate -s time.google.com 2>/dev/null; then
            echo "Time restored successfully to: $(date)"
          else
            echo "Error: Failed to sync with public NTP servers."
          fi
          ;;
        -i|--info)
          echo "Current time information:"
          echo "=========================="
          echo "Current time: $(date)"
          echo "Current timezone: $(timedatectl show --property=Timezone --value)"
          ;;
        *)
          print_usage
          ;;
      esac
    '')

    # Time utilities
    ntp
    tzdata
    wordlists

    # Burp Suite Pro
    (unstable.burpsuite.override { proEdition = true; })

    # VPN
    openvpn

    # Web scanning
    dirb
    whatweb
    gobuster
    monsoon
    feroxbuster

    # XSS/Injection
    dalfox

    # SNMP
    snmpcheck
    net-snmp
    braa
    onesixtyone

    # SMB/Windows
    enum4linux-ng
    smbmap

    # Python pentesting libs
    python312Packages.impacket
    python312Packages.bloodyad
    python312Packages.pyftpdlib
    python312Packages.roadrecon

    # Active Directory
    certipy
    openldap
    ldapdomaindump
    bloodhound-py
    autobloody
    silenthound
    adalanche
    kerbrute
    responder

    # MITM
    mitmproxy
    mitmproxy2swagger
    bettercap
    websploit

    # Network scanning
    nikto
    nmap
    rustscan
    chisel
    wireshark
    fping
    tcpdump
    tshark
    termshark
    netexec

    # OSINT
    uncover
    sherlock
    theharvester
    trufflehog
    maltego

    # DNS
    dig
    dnsrecon
    dnsx
    subfinder
    dnsenum
    fierce
    amass

    # Brute forcing
    hydra-cli
    thc-hydra
    crowbar

    # Password cracking
    hash-identifier
    hashid
    hashcat
    ocl-icd
    zlib
    opencl-headers
    john
    ophcrack-cli

    # Wordlist tools
    crunch
    cewl
    rsmangler
    username-anarchy
    creds

    # Exploitation
    unstable.metasploit
    sqlmap
    pysqlrecon
    evil-winrm
    mimikatz
    powersploit

    # Mobile
    ghost

    # Netcat alternatives
    rustcat
    snicat

    # WiFi
    bully
    cowpatty
    aircrack-ng
    airgeddon
    wifite2
    hcxdumptool
    hcxtools
    pixiewps

    # Database
    samba
    exploitdb
    redis
    mariadb
    sqsh
    freetds

    # CMS
    wprecon
    wpscan

    # Forensics
    foremost
    binwalk
    testdisk

    # WiFi tools
    dbmonster
    linux-router
    hostapd-mana

    # Steganography
    exiftool
    steghide
    stegseek
    stegsolve
    zsteg
    pngcheck
    outguess
    aeskeyfind

    # More tools
    reaverwps
    reaverwps-t6x
    macchanger
    wfuzz
    ffuf
    nfs-utils
    openssl
    ssh-audit
    wafw00f
    zap
    medusa
    rpcbind
    nbtscan
    nbtscanner
    firewalk
    upx
    go365
    swaks
    updog
    ghidra
    avalonia-ilspy
    freerdp3
    corkscrew
    sshuttle

    # Cross-compilation
    pkgsCross.mingwW64.buildPackages.gcc
  ];

  # MySQL/MariaDB service
  services.mysql = {
    enable = true;
    package = pkgs.mariadb;
  };

  # Fish shell abbreviations for tool directories
  programs.fish.shellAbbrs = {
    dsviper = "cd /home/traum/tools/DSViper && nix-shell";
    havoc = "cd /home/traum/tools/Havoc && nix-shell";
    nanodump = "cd /home/traum/tools/nanodump && nix-shell";
    donut = "cd /home/traum/tools/donut && nix-shell";
    csbof = "cd /home/traum/tools/CS-Situational-Awareness-BOF && nix-shell";
  };
}
